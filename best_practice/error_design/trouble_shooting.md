# トラブルシューティング・デバッグ

■ シンプルに実装しパフォーマンスを計測する

計測した速度が想定範囲内であれば多少遅くてもそれ以上改善すべきではない。  
速度を改善する必要がある場合は、開発環境やより本番に近いデータを持つ検証環境で実行時の  
情報を収集し、複数の仮説を立て、可能性を排除していく必要がある。  
Django の場合、「Django Debug Toolbar」で Django で開発した web アプリケーションにツールバーを追加し、  
リクエスト時の内部状態を表示する。

■ トランザクション内はなるべく短い時間で処理する。

- 問題点：ブラウザからのリクエスト処理開始時に DB のトランザクション処理を開始すると、何か問題があった場合に、中途半端なデータ更新が行われる。

以下の複数の観点で対策する。

- リクエスト全体をトランザクションとする場合、リクエスト処理にかかる時間を短くする。
  - 処理時間が短ければ、前述のトラブルを避けられるだけでなく、ワーカープロセス占有によるリクエスト詰まりが起こりにくくなり、利用者からみた全体的な体感速度も向上する。そのため、リクエストの処理内で外部の web API にアクセスしたり、ファイルをダウンロードしたりといった時間がかかる処理は非同期にする。
- トランザクション処理を自動にせず、必要最小限の範囲に明示的に設定する。
  - 商品を購入する処理であれば、在庫確認やクレジットカードの有効性確認などはトランザクション外で行い、商品購入を確定できる前提がそろって初めてトランザクションを開始する。
- DB のトランザクション分離レベルを設計時に選択する。
