# ネットワーク

■127.0.0.1 と 0.0.0.0 の違い

- 127.0.0.1：ローカルループパブリックという、そのコンピュータ内でのみアクセス可能なネットワークインタフェース。
  - 同じコンピューター内からはアクセスできるが、コンピューター外からはアクセスできない。
- バインド：「127.0.0.1:8000 を使う」こと。
- コンピューター外と直接通信するには、コンピューター外との通信用ネットワークインタフェースの IP にバインドして起動する。
  - 例)python manage.py runserver 192.168.99.1:8000(0.0.0.0:8000 はグローバル通信)

ネットワークインタフェースの一覧は ifconfig や ip addr コマンドで確認できる。それぞれ lo や eth0 といった名前である。  
外部からアクセス可能にするには、eth0 などのコンピューター外部と繋がっているネットワークインタフェースの IP アドレスを調べて、  
その IP アドレスにバインドする。

- 0.0.0.0 は想定外の誰かが、アクセスして web アプリを見られてしまう必要があるため、外部からのアクセス制限がされている
  - 開発サーバーや仮想マシン内で使用し、個人端末では、本当に必要な時だけ指定するようにする。

■ リバースプロキシ

- <img width="978" alt="image" src="https://github.com/yoshikikasama/python/assets/61643054/2ed72579-ce2d-461e-aa86-4a0609e77196">

- リバースプロキシ：web サーバーで受け取ったリクエストをバックエンドの web アプリケーションサーバー(Gunicorn, Apache, Nginx)に渡すフロントの web サーバー。
  - インターネットでは web サイトに対してロングポーリングや巨大なリクエストを送りつけるといった多種多様な攻撃が日々繰り返されており、
  - こういった攻撃に対する仕組みは Gunicorn や Django では提供されていない。
- プロキシサーバー：受け取ったリクエストを他のサーバーに転送するサーバーのこと。
- web サーバーとして Apache や Nginx などを設置し、web アプリケーションサーバーにリバースプロキシで接続する。
- ヘッダーについている「X-」は独自仕様という意味。

■Unix ドメインソケット

- web サーバーと web アプリケーションサーバーの通信方式を合わせる。可能なら TCP よりも高速な Unix ドメインソケットによるリバースプロキシ接続を行う。
- Unix ドメインソケットによる通信では、ファイルパスで通信を行う。
  - 例) gunicorn -b unix:/var/run/gunicorn.sock apps.wsgi.application

■ 不正なドメイン名でのアクセスを拒否する

- 不正なドメイン名でのアクセスを拒否するように、web サーバーの名前ベースのバーチャルホストを設定する。
- 攻撃が Django まで届かないように設定することでサーバーリソースの消費や不要なエラーメール通知がなくなる。

例)

```
server {
    listen 80 default_server;
    return 444;
}

server{
    listen 80;
    server_name app.example.com;
    location /{
        proxy_pass http://webapp:8000/;
    }
}
```

- この設定では listen 80 default_server という設定を持った server ディレクティブを追加して、不正なドメイン名へのアクセスを全て受信するようにしている。そして return 444;によって Nginx がリクエスト元にレスポンスを返さずに即座に通信を切断するように指示している。これによって、不正なリクエストが web サーバーへ届かないようになっている。

■ hosts ファイルを変更してドメイン登録と異なる IP アドレスにアクセスする

- ssh port forwarding で localhost の 8000 番 port を開発サーバーの 80 番ポートに転送したが、Nginx の設定で localhost が不正なドメイン名として設定されている。
  - 正しい URL はhttp://app.exmaple.comだがIP制限している
- hosts ファイルを変更してドメイン名に任意の IP アドレスを関連付ける。hosts ファイルは DNS よりも先に参照される、IP アドレスとドメイン名の対応を記載したファイル。
- 例) /etc/hosts

  - 127.0.0.1 app.example.com

- これで app.example.com への通信は IP アドレス 127.0.0.1 へ送信され、ssh portforward 経由でサーバーへリクエストが送られる。

- Firefox は proxy 通信設定が OS の設定から独立しているため、一時的な開発用途での proxy の設定変更であれば Firefox を利用する。
