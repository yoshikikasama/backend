# リソース設計

■ ファイルパスはプログラムからの相対パスで組み立てる

- 実行するディレクトリによってファイルやモジュールが見つからずに import エラーとなる。
- どこからプログラムが実行されても適切に動くようにパスを組み立てるようにする。

```python

# projects/scripts/read_csv.py
# projects/scripts/target.csv

import csv
from pathlib import Path

# 起点となるプログラムがあるパス
here = Path(__file__).parent
CSV_PATH = here / 'target.csv'

with CSV_PATH.open(mode='r') as fp:
    reader = csv.reader(fp)
    for row in reader:
        print(row)
```

- python では**file**でそのファイルへのパスを取得できる。そこから現在のディレクトリのパスを取得して、相対的な外部ファイルまでのパスを組み立てれば、どこからプログラムが実行されてもファイルが見つかる。Django でも BASE_DIR で起点となるパスを定義してそれを利用してパスを組み立てたりする。

■ ファイルを格納するディレクトリを分散させる

- 作成したすべてのファイルを 1 つのディレクトリに置くと、パフォーマンスの低下などの問題が生じる。
- データベースで自動採番される ID などを利用してディレクトリを分けるなどする。

■ 一時的な作業ファイルは絶対に競合しない名前を使う

- 一時的な作業ファイルは一時ファイル置き場に作成する。
- アクセス数が少ない場合でも偶然タイミングがあってしまえば、競合問題が発生する。
- Python であれば tempfile モジュールを使用すれば、ファイル名の競合を避けて、一時的なファイル作成ができる。

```python
import tempfile

with tempfile.NamedTemporaryFile(prefix='receipt-') as f:
    f.write(data)
    send_file(f.name)

# withブロックを抜けるとファイルは自動的に削除される
```

■ セッションデータの保存には RDB か KVS を使用する

- セッションを web アプリケーションサーバーのファイルシステムに保存すると以下の問題がある

  - セッションファイル数に比較して DISK への負荷が増える
  - セッションファイルが増え続け、DISK が溢れる
  - 複数のアプリケーションサーバーを多重化した場合、どちらのサーバーにセッションがあるかによってログイン状態が変わってしまう

- RDB:
  - 利用は簡単だが同時書き込みの負荷が高い。
  - にセッションを保存すると、複数の web アプリケーションサーバーでセッションデータを共有できる。
  - RDB のセッションデータも削除するように manage.py clearsessions コマンドを 1 日 1 回呼び出すように cron や systemd.timer を設定しておく。
- Redis(KVS):
  - 読み込み高速
  - 良い点は利用期限を過ぎたセッションデータが自動的に削除されること。
- ファイルシステム: 性能管理が難しく、NFS 設定と運用のコストが高い
- ブラウザの Cookie に保存: 保存できるサイズの上限が 4000-5000byte と小さく、別端末共有できない。
