# ユニットテスト

■ テストにテスト対象と同等の実装を書かない(case1)

- テスト内で入出力を確認するときは文字列や数値などの値をテスト内に直接書く。

■ 1 つのテストメソッドでは 1 つの項目のみ確認する

■ 読みやすくするためにテストコードを準備(Arrange)と実行(Act)と検証(Assert)に

- Arrange Act Assert Pattern
- コメント+準備と実行検証の 3 段階に空白行で分割してあげるだけでどこからが準備でどこから実行でというのがわかりやすくなる。

https://testdriven.io/tips/f8aac8a8-c53b-4611-8817-8a0a7b2269dd/

■ テストしにくい実装は設計が悪い(case2)

- テストをより良く書こうとするのではなく、そもそも実装の設計を見直す。
- 細かい条件や分岐の処理を別の関数にする。
- 全体を通すような処理は分岐を網羅するだけのテストメソッドで十分とする。
- 細かい条件はここに分離した単体テスト内でテストするので保証しなくても良い。
- テストしやすい設計＝＝メンテナンス性の高い良い設計
- mock などで無理に単体テストを通すよりも関数設計が良くならないか、データ設計、モデル設計が良くならないかと考えることが大切。
- 関数の引数やフィクスチャーに大げさな値が必要な設計にしない
- 処理を分離して全ての動作確認に全てのデータが必要ないようにする
- 関数やクラスを分離して、細かいテストは分離した関数、クラスを対象に行う（分離した関数を呼び出す関数では細かいテストは書かないようにする。)

■ 外部 API の Mock 化(case3)

- 単体テストから外部環境への依存を排除する。requests がバックエンドサーバーへアクセスするのを responses を使って mock する。
- 外部の API やサービス
  - responses を使って mock 化する
- データベースやサーバーなどのミドルウェア(Mysql や Redis など)
  - RDB は backend を SQLite に置き換える。
  - Redis は fakeredis に置き換える
- クラウドサービス(S3, DynamoDB など)
  - moto でモックに置き換える。
- 単体テストを実行する PC 環境やディレクトリー構成
  - 標準ライブラリーの tempfile を使う
  - プロジェクト内の仮想環境 venv など、バージョン管理システムで管理されないファイルに依存しない。

■test 用のデータは test 終了後に削除する(case4)

- test 用に生成されたファイルが原因で、別のテストが失敗してしまったり不必要にマシンのディスク容量を占有してしまったりする。
- tempfile モジュールにある NamedTemporaryFile を使うと一時的なファイルが作られ、ファイルクローズと同時に自動的に削除してくれる。
- 自動で削除されない場合でも teardown method などで必ず削除すべき。

■ 便利なテストユーティリティー(case5)

- django.test.TestCase・・・Django のプロジェクトをテストする場合に便利な assert メソッドを持っているテストケースクラス。
- django.core.mail.outbox・・・テスト中に送信されたメールが保存されているオブジェクト。メールの中身が正しいかをテストできる。
- freezegun・・・mock.patch できない datetime.now を簡単にパッチできる。
- pytest・・・tempfile をより便利に使える tmpdir など付属の機能が提供されている。
- pytest-django・・・pytest で Django プロジェクトをテストする場合に使う
- pytest-freezegun・・・freezegun を pytest で便利に使えるツール
- pytest-responses・・・responses を pytest で便利に使えるツール
- ユーティリティーのまとめ:
  - testing.py プロジェクト内で汎用的に使える機能をテストユーティリティーとしてまとめておく。モジュールなどに関数などを分離してまとめておく。
  - fragile fixture のサイトでも確認。

■ テストケースごとにテストデータを用意する。(case6)

- fixture を使い回すと他の開発者が別のテストを修正する目的で変更したら既存のテストが失敗することになる。
- fixture(conftest)をうまく活用する。
- parametrize をうまく活用する。

■ 必要十分なテストデータを用意する。(case7)

- テストをしやすいように条件となる数値を引数として用意する。テストの時に数値を変えて実行する。
  - システムが大きくなればなるほど、テストにかかる時間が増えていきます。
  - テストの準備のために大量にデータを作らなければならない場面に遭遇したら、本当に大量のデータが必要か確認する。

■ 条件に合致しないテストデータも用意する

- いくら条件を指定しても合致するデータが存在しないので、本当に条件に合致したデータだけが絞り込まれているかという点が 十分に確認できていないケースがある。

■ テストの実行順序に依存しないテストを書く

- データを使いまわさない。
- メソッド間で共通のデータを持たない。

■ 戻り値がリストの関数のテストで要素数をテストする

- 要素数を確認しないとリストに 3 つ目の値がある可能性があるので、必ず確認する。

■ テストで確認する内容に関するデータのみ作成する

- テストで確認する内容に関係するデータのみ作成する
- テストに関係しないデータ、パラメーターを作らない、指定しない。
- テストに関係するデータ、パラメーターを作る、指定する(デフォルトに依存しない)

■ 過剰な mock を避ける

- mock は外部アクセスなど、単体テストに含めたくない項目のみに使う。データベースアクセスなどは、factory-boy で  
  &nbsp; 比較的簡単にデータが作れるので、mock は使わない方がいい。
